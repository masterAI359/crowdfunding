name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Verify SSH connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VPS_USER@$VPS_HOST "echo 'SSH connection successful'"; then
            echo "SSH connection verified"
          else
            echo "SSH connection failed"
            exit 1
          fi

      - name: Pull latest changes
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            cd ~/dev/frontend
            echo "Pulling latest changes..."
            git checkout main
            eval $(ssh-agent -s)
            ssh-add ~/.ssh/admin
            git pull
            echo "Code updated successfully"
            # Load shell profile to get PATH and environment variables
            source ~/.bashrc || source ~/.profile || true
            export PATH="$HOME/.local/bin:$HOME/.local/share/pnpm:$PATH"
            export PATH="/usr/local/bin:/usr/bin:$PATH"
            # Load nvm if available (common Node.js version manager)
            [ -s "$HOME/.nvm/nvm.sh" ] && source "$HOME/.nvm/nvm.sh"
            [ -s "/usr/local/nvm/nvm.sh" ] && source "/usr/local/nvm/nvm.sh"
            echo "Building application..."
            # Ensure Node.js/npm is available
            if ! command -v npm &> /dev/null; then
              echo "Error: npm not found. Please install Node.js on the server."
              exit 1
            fi
            # Ensure pnpm is available
            if ! command -v pnpm &> /dev/null; then
              echo "Installing pnpm globally..."
              npm install -g pnpm
            fi
            # Add pnpm to PATH if installed via npm
            export PATH="$HOME/.npm-global/bin:$PATH"
            export PATH="$HOME/.local/share/pnpm:$PATH"
            if [ -f "pnpm-lock.yaml" ]; then
              pnpm build
            else
              npm run build
            fi
            echo "Build completed successfully"
            echo "Reloading PM2 process..."
            pm2 reload 0
            echo "PM2 process reloaded"
            echo "Verifying deployment..."
            
            # Check if PM2 process is running
            if pm2 describe 2 | grep -q "online"; then
              echo "PM2 process is running"
            else
              echo "PM2 process is not running"
              exit 1
            fi
          ENDSSH